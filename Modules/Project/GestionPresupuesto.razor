@page "/proyectos/gestion-presupuesto"
@page "/proyectos/gestion-presupuesto/{ProjectId:int}"

@using Microsoft.EntityFrameworkCore
@using WorkFlow_SIG10._1.Data
@using WorkFlow_SIG10._1.Models
@using WorkFlow_SIG10._1.Shared
@using WorkFlow_SIG10._1.Utilities // Gemini: Added using

@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject NavigationManager NavigationManager

<PageTitle>Gestión de Presupuesto</PageTitle>

<h3>Gestión de Presupuesto</h3>

@if (selectedProjectId == null)
{
    <p>Seleccione un proyecto para ver su presupuesto.</p>
    <div class="card card-style">
        <div class="card-body">
            @if (!allProjects.Any()) { <p><em>Cargando proyectos...</em></p> }
            else
            {
                <div class="list-group">
                    @foreach (var p in allProjects)
                    {
                        <a @onclick="() => NavigateToProject(p.ProyectoID)" @onclick:preventDefault style="cursor: pointer;" class="list-group-item list-group-item-action">
                            <h5 class="mb-1">@p.NombreObra</h5><small>@p.Estado</small>
                        </a>
                    }
                </div>
            }
        </div>
    </div>
}
else if (proyecto == null)
{
    <p><em>Cargando presupuesto...</em></p>
}
else
{
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4>Presupuesto para: @proyecto.NombreObra</h4>
        <div>
            <button class="btn btn-primary me-2" @onclick="OpenFinancialModal">
                <span class="oi oi-cog" aria-hidden="true"></span> Configurar Totales
            </button>
            <button class="btn btn-success" @onclick="GuardarCambios" disabled="@(!cambiosPendientes.Any())">
                <span class="oi oi-hard-drive" aria-hidden="true"></span> Guardar Cambios
            </button>
        </div>
    </div>

    <div class="financial-summary-card sticky-summary">
        <h5 class="mb-3">Resumen Financiero del Contrato</h5>
        @if (financialSummary != null)
        {
            <div class="row">
                <div class="col-md-4">
                    <p class="mb-1"><strong>Costo Directo:</strong></p>
                    <p class="fs-5">@FormatUtils.FormatCurrency(financialSummary.CostoDirecto)</p> <!-- Gemini: Formatting Change -->
                </div>
                <div class="col-md-8">
                    <div class="row">
                        <div class="col-6"><small>+ Gastos Generales:</small></div>
                        <div class="col-6 text-end"><small>@FormatUtils.FormatCurrency(financialSummary.GastosGenerales)</small></div> <!-- Gemini: Formatting Change -->
                        <div class="col-6"><small>+ Costos Indirectos:</small></div>
                        <div class="col-6 text-end"><small>@FormatUtils.FormatCurrency(financialSummary.CostosIndirectos)</small></div> <!-- Gemini: Formatting Change -->
                        <div class="col-6"><small>+ Utilidad:</small></div>
                        <div class="col-6 text-end"><small>@FormatUtils.FormatCurrency(financialSummary.Utilidad)</small></div> <!-- Gemini: Formatting Change -->
                    </div>
                </div>
            </div>
            <hr class="my-2">
            <div class="row align-items-center">
                <div class="col-md-4">
                    <p class="mb-1"><strong>Costo Neto:</strong></p>
                    <p class="fs-5">@FormatUtils.FormatCurrency(financialSummary.CostoNeto)</p> <!-- Gemini: Formatting Change -->
                </div>
                <div class="col-md-8">
                    <div class="row">
                        <div class="col-6"><small>+ IVA (@FormatUtils.FormatPercentage(proyecto.IVAPorcentaje / 100)):</small></div> <!-- Gemini: Formatting Change -->
                        <div class="col-6 text-end"><small>@FormatUtils.FormatCurrency(financialSummary.MontoIVA)</small></div> <!-- Gemini: Formatting Change -->
                    </div>
                </div>
            </div>
            <hr class="my-2">
            <div class="row text-success">
                <div class="col-md-4">
                    <p class="mb-1"><strong>COSTO TOTAL:</strong></p>
                </div>
                <div class="col-md-8 text-end">
                    <p class="fs-4 fw-bold">@FormatUtils.FormatCurrency(financialSummary.CostoTotal)</p> <!-- Gemini: Formatting Change -->
                </div>
            </div>
        }
        else
        {
            <p><em>Calculando resumen financiero...</em></p>
        }
    </div>

    <div class="card card-style">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-modern">
                    <thead class="thead-light">
                        <tr>
                            <th class="wbs-column">WBS</th>
                            <th>Nombre Tarea</th>
                            <th>Unidad</th>
                            <th>Cantidad</th>
                            <th>Precio Unitario</th>
                            <th>Importe Contrato</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var tarea in TareasParaRenderizar)
                        {
                            <RenderPresupuestoTarea Tarea="tarea" 
                                                  Nivel="@(tarea.WBS.Count(c => c == '.'))" 
                                                  OnChange="MarcarComoCambiado" />
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <FinancialConfigModal @ref="financialModal" OnFinancialsUpdated="HandleFinancialsUpdated" />
}

@code {
    [Parameter] public int? ProjectId { get; set; }

    private int? selectedProjectId;
    private List<Proyecto> allProjects = new();
    private Proyecto? proyecto;
    private List<Tarea> TareasNivelSuperior = new();
    private Dictionary<int, Tarea> todasLasTareasMap = new();
    private HashSet<Tarea> cambiosPendientes = new();

    private FinancialConfigModal? financialModal;
    private FinancialSummaryViewModel? financialSummary;

    private List<Tarea> TareasParaRenderizar => FlattenTareasForDisplay(TareasNivelSuperior);

    protected override async Task OnInitializedAsync()
    {
        using var context = DbFactory.CreateDbContext();
        allProjects = await context.Proyectos.AsNoTracking().ToListAsync();
    }

    protected override async Task OnParametersSetAsync()
    {
        if (ProjectId.HasValue && selectedProjectId != ProjectId.Value)
        {
            selectedProjectId = ProjectId.Value;
            await CargarDatosProyecto();
        }
        else if (!ProjectId.HasValue)
        {
            selectedProjectId = null;
            proyecto = null;
            TareasNivelSuperior.Clear();
            todasLasTareasMap.Clear();
            cambiosPendientes.Clear();
            financialSummary = null;
        }
    }

    private async Task CargarDatosProyecto()
    {
        cambiosPendientes.Clear();
        using var context = DbFactory.CreateDbContext();
        
        proyecto = await context.Proyectos.AsNoTracking().FirstOrDefaultAsync(p => p.ProyectoID == selectedProjectId);

        if (proyecto != null)
        {
            var todasLasTareas = await context.Tareas.AsNoTracking()
                .Where(t => t.ProyectoId == selectedProjectId)
                .OrderBy(t => t.WBS)
                .ToListAsync();
            
            todasLasTareasMap = todasLasTareas.ToDictionary(t => t.TareaId);
            TareasNivelSuperior.Clear();

            foreach (var tarea in todasLasTareas)
            {
                tarea.Subtareas.Clear();
                if (tarea.TareaPadreId.HasValue && todasLasTareasMap.TryGetValue(tarea.TareaPadreId.Value, out var padre))
                {
                    padre.Subtareas.Add(tarea);
                }
                else if (tarea.WBS != "0" && tarea.UidMsProject != 0)
                {
                    TareasNivelSuperior.Add(tarea);
                }
            }
            
            UpdateFinancialSummary();
        }
        await InvokeAsync(StateHasChanged);
    }

    private void UpdateFinancialSummary()
    {
        if (proyecto == null) return;

        var costoDirecto = todasLasTareasMap.Values
            .Where(t => !t.EsResumen)
            .Sum(t => t.ImporteContrato);

        financialSummary = new FinancialSummaryViewModel(proyecto, costoDirecto);
    }

    private List<Tarea> FlattenTareasForDisplay(List<Tarea> tareas)
    {
        var flatList = new List<Tarea>();
        foreach (var tarea in tareas.OrderBy(t => t.WBS))
        {
            flatList.Add(tarea);
            if (tarea.Subtareas.Any())
            {
                flatList.AddRange(FlattenTareasForDisplay(new List<Tarea>(tarea.Subtareas)));
            }
        }
        return flatList;
    }

    private async Task MarcarComoCambiado(Tarea tareaModificada)
    {
        cambiosPendientes.Add(tareaModificada);

        if (tareaModificada.TareaPadreId.HasValue && todasLasTareasMap.TryGetValue(tareaModificada.TareaPadreId.Value, out var padre))
        {
            RecalcularResumen(padre);
        }
        
        UpdateFinancialSummary();
        await InvokeAsync(StateHasChanged);
    }

    private void RecalcularResumen(Tarea tareaResumen)
    {
        tareaResumen.ImporteContrato = tareaResumen.Subtareas.Sum(t => t.ImporteContrato);
        cambiosPendientes.Add(tareaResumen);

        if (tareaResumen.TareaPadreId.HasValue && todasLasTareasMap.TryGetValue(tareaResumen.TareaPadreId.Value, out var abuelo))
        {
            RecalcularResumen(abuelo);
        }
    }

    private async Task GuardarCambios()
    {
        if (!cambiosPendientes.Any()) return;

        using var context = DbFactory.CreateDbContext();
        
        foreach (var tareaModificada in cambiosPendientes)
        {
            context.Tareas.Attach(tareaModificada);
            context.Entry(tareaModificada).Property(x => x.ImporteContrato).IsModified = true;

            if (!tareaModificada.EsResumen)
            {
                context.Entry(tareaModificada).Property(x => x.Unidad).IsModified = true;
                context.Entry(tareaModificada).Property(x => x.CantidadContrato).IsModified = true;
                context.Entry(tareaModificada).Property(x => x.PrecioUnitario).IsModified = true;
            }
        }

        await context.SaveChangesAsync();
        cambiosPendientes.Clear();
        await InvokeAsync(StateHasChanged);
    }

    private void NavigateToProject(int projectId)
    {
        NavigationManager.NavigateTo($"/proyectos/gestion-presupuesto/{projectId}");
    }

    private async Task OpenFinancialModal()
    {
        if (selectedProjectId.HasValue && financialModal != null)
        {
            await financialModal.Show(selectedProjectId.Value);
        }
    }

    private async Task HandleFinancialsUpdated()
    {
        await CargarDatosProyecto();
    }

    public class FinancialSummaryViewModel
    {
        private readonly Proyecto _proyecto;
        public decimal CostoDirecto { get; }

        public FinancialSummaryViewModel(Proyecto proyecto, decimal costoDirecto)
        {
            _proyecto = proyecto;
            CostoDirecto = costoDirecto;
        }

        public decimal GastosGenerales => _proyecto.TipoGastosGenerales == TipoDeCosto.Porcentaje
            ? CostoDirecto * (_proyecto.ValorGastosGenerales / 100)
            : _proyecto.ValorGastosGenerales;

        public decimal CostosIndirectos => _proyecto.TipoCostosIndirectos == TipoDeCosto.Porcentaje
            ? CostoDirecto * (_proyecto.ValorCostosIndirectos / 100)
            : _proyecto.ValorCostosIndirectos;

        public decimal Utilidad
        {
            get
            {
                if (_proyecto.TipoUtilidad == TipoDeCosto.Porcentaje)
                {
                    var subtotal = CostoDirecto + GastosGenerales + CostosIndirectos;
                    return subtotal * (_proyecto.ValorUtilidad / 100);
                }
                return _proyecto.ValorUtilidad;
            }
        }

        public decimal CostoNeto => CostoDirecto + GastosGenerales + CostosIndirectos + Utilidad;
        public decimal MontoIVA => CostoNeto * (_proyecto.IVAPorcentaje / 100);
        public decimal CostoTotal => CostoNeto + MontoIVA;
    }
}
