@page "/estados-de-pago/crear/{ProyectoId:int}"
@using Microsoft.EntityFrameworkCore
@using WorkFlow_SIG10._1.Data
@using WorkFlow_SIG10._1.Models
@using System.Globalization
@using WorkFlow_SIG10._1.Utilities // Gemini: Added using for FormatUtils
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime

<PageTitle>Crear Estado de Pago</PageTitle>

<div class="container-fluid">
    <h1 class="mt-4">Crear Nuevo Estado de Pago para el Proyecto: @Proyecto?.NombreObra</h1>

    @if (Proyecto == null)
    {
        <p>Cargando proyecto...</p>
    }
    else
    {
        <div class="card card-style mt-4">
            <div class="card-body">
                <h5 class="card-title">Carátula del Estado de Pago (Resumen)</h5>
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Proyecto:</strong> @Proyecto.NombreObra</p>
                        <p><strong>Código:</strong> @Proyecto.CodigoObra</p>
                        <p><strong>Fecha Creación EP:</strong> @FormatUtils.FormatDate(CurrentEP.FechaCreacion)</p> <!-- Gemini: Formatting Change -->
                        <p><strong>Estado EP:</strong> @CurrentEP.Estado</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Total Contrato Original Neto (T1):</strong> @FormatUtils.FormatCurrency(CurrentEP.TotalContratoOriginalNeto)</p> <!-- Gemini: Formatting Change -->
                        <p><strong>Total Ampliaciones Neto (T2):</strong> @FormatUtils.FormatCurrency(CurrentEP.TotalAmpliacionesNeto)</p> <!-- Gemini: Formatting Change -->
                        <p><strong>Total Penalizaciones Neto (T3):</strong> @FormatUtils.FormatCurrency(CurrentEP.TotalPenalizacionesNeto)</p> <!-- Gemini: Formatting Change -->
                        <p><strong>Total Contrato Actualizado Neto (T4):</strong> @FormatUtils.FormatCurrency(CurrentEP.TotalContratoActualizadoNeto)</p> <!-- Gemini: Formatting Change -->
                    </div>
                </div>
                <hr />
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Avance Período Neto:</strong> @FormatUtils.FormatCurrency(CurrentEP.AvancePeriodoNeto)</p> <!-- Gemini: Formatting Change -->
                        <p><strong>Retención del Período (5%):</strong> @FormatUtils.FormatCurrency(CurrentEP.RetencionPeriodoNeto)</p> <!-- Gemini: Formatting Change -->
                    </div>
                    <div class="col-md-6">
                        <p><strong>Total a Facturar Avance Mensual:</strong> @FormatUtils.FormatCurrency(CurrentEP.TotalImporteFacturacionAvanceMensual)</p> <!-- Gemini: Formatting Change -->
                    </div>
                </div>
            </div>
        </div>

        <div class="card card-style mt-4">
            <div class="card-body">
                <h5 class="card-title">Estado de Mediciones (Detalle de Ítems de Presupuesto)</h5>
                <div class="table-responsive">
                    <table class="table table-striped table-bordered">
                        <thead>
                            <tr>
                                <th>Código</th>
                                <th>Descripción</th>
                                <th>Unidad</th>
                                <th>Cant. Contrato</th>
                                <th>Precio Unitario</th>
                                <th>Importe Contrato</th>
                                <th>Avance Período (Cant.)</th>
                                <th>Avance Período (Importe)</th>
                                <th>Avance Acumulado (Cant.)</th>
                                <th>Avance Acumulado (Importe)</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in EpItems)
                            {
                                <tr>
                                    <td>@item.ItemPresupuesto.Codigo</td>
                                    <td>@item.ItemPresupuesto.Descripcion</td>
                                    <td>@item.ItemPresupuesto.Unidad</td>
                                    <td>@FormatUtils.FormatNumber(item.ItemPresupuesto.Cantidad)</td> <!-- Gemini: Formatting Change -->
                                    <td>@FormatUtils.FormatCurrency(item.ItemPresupuesto.PrecioUnitario)</td> <!-- Gemini: Formatting Change -->
                                    <td>@FormatUtils.FormatCurrency(item.ItemPresupuesto.ImporteTotal)</td> <!-- Gemini: Formatting Change -->
                                    <td>
                                        <InputText @bind-Value="item.CantidadAvancePeriodoText"
                                                   @oninput="(() => OnCantidadAvancePeriodoChanged(item))"
                                                   class="form-control" />
                                    </td>
                                    <td>@FormatUtils.FormatCurrency(item.ImporteAvancePeriodo)</td> <!-- Gemini: Formatting Change -->
                                    <td>@FormatUtils.FormatNumber(item.CantidadAvanceAcumulado)</td> <!-- Gemini: Formatting Change -->
                                    <td>@FormatUtils.FormatCurrency(item.ImporteAvanceAcumulado)</td> <!-- Gemini: Formatting Change -->
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="mt-4 text-center">
            <button class="btn btn-success me-2" @onclick="@(() => SaveEstadoDePago("Borrador"))"><span class="btn-content">Guardar Borrador</span></button>
            <button class="btn btn-primary me-2" @onclick="@(() => SaveEstadoDePago("Enviado"))"><span class="btn-content">Finalizar y Enviar</span></button>
            <button class="btn btn-secondary" @onclick="NavigateBack"><span class="btn-content">Cancelar</span></button>
        </div>
    }
</div>

@code {
    [Parameter]
    public int ProyectoId { get; set; }

    private Proyecto? Proyecto;
    private List<AmpliacionProyecto> Ampliaciones = new();
    private List<Penalizacion> Penalizaciones = new();
    private EstadoDePago CurrentEP = new();
    private List<EstadoDePagoItemViewModel> EpItems = new();

    // private CultureInfo EsClCulture = CultureInfo.GetCultureInfo("es-CL"); // Gemini: Removed, now using FormatUtils

    protected override async Task OnInitializedAsync()
    {
        using var context = DbFactory.CreateDbContext();

        Proyecto = await context.Proyectos
                                .Include(p => p.AmpliacionesProyectos)
                                .Include(p => p.Penalizaciones)
                                .FirstOrDefaultAsync(p => p.ProyectoID == ProyectoId);

        if (Proyecto != null)
        {
            Ampliaciones = Proyecto.AmpliacionesProyectos.ToList();
            Penalizaciones = Proyecto.Penalizaciones.ToList();

            CurrentEP = new EstadoDePago
            {
                ProyectoId = ProyectoId,
                FechaCreacion = DateTime.Now,
                Estado = "Borrador",
                TotalAmpliacionesNeto = Ampliaciones.Sum(a => a.Monto),
                TotalPenalizacionesNeto = Penalizaciones.Sum(p => p.Monto),
            };

            EpItems = await context.ItemsPresupuesto
                                   .Where(ip => ip.ProyectoId == ProyectoId)
                                   .OrderBy(ip => ip.Codigo)
                                   .Select(ip => new EstadoDePagoItemViewModel(ip)) // Gemini: Simplified constructor call
                                   .ToListAsync();

            CalculateSummary();
        }
    }

    private void OnCantidadAvancePeriodoChanged(EstadoDePagoItemViewModel item)
    {
        item.Recalculate();
        CalculateSummary();
    }

    private void CalculateSummary()
    {
        CurrentEP.TotalContratoOriginalNeto = EpItems.Sum(item => item.ItemPresupuesto.ImporteTotal);
        CurrentEP.TotalAmpliacionesNeto = Ampliaciones.Sum(a => a.Monto);
        CurrentEP.TotalPenalizacionesNeto = Penalizaciones.Sum(p => p.Monto);
        CurrentEP.TotalContratoActualizadoNeto = CurrentEP.TotalContratoOriginalNeto + CurrentEP.TotalAmpliacionesNeto - CurrentEP.TotalPenalizacionesNeto;
        CurrentEP.AvancePeriodoNeto = EpItems.Sum(item => item.ImporteAvancePeriodo);
        CurrentEP.RetencionPeriodoNeto = CurrentEP.AvancePeriodoNeto * 0.05m;
        CurrentEP.TotalImporteFacturacionAvanceMensual = CurrentEP.AvancePeriodoNeto - CurrentEP.RetencionPeriodoNeto;
    }

    private void NavigateBack()
    {
        NavigationManager.NavigateTo("/estados-de-pago");
    }

    private async Task SaveEstadoDePago(string estado)
    {
        try
        {
            using var context = DbFactory.CreateDbContext();
            CurrentEP.Estado = estado;
            CurrentEP.Proyecto = Proyecto!;
            context.EstadosDePago.Add(CurrentEP);

            foreach (var epItemViewModel in EpItems)
            {
                if (string.IsNullOrWhiteSpace(epItemViewModel.ItemPresupuesto.Descripcion) ||
                    string.IsNullOrWhiteSpace(epItemViewModel.ItemPresupuesto.Unidad) ||
                    epItemViewModel.ItemPresupuesto.Cantidad <= 0 ||
                    epItemViewModel.ItemPresupuesto.PrecioUnitario <= 0)
                {
                    throw new InvalidOperationException($"El ítem de presupuesto con código '{epItemViewModel.ItemPresupuesto.Codigo}' tiene datos incompletos o inválidos y no puede ser guardado.");
                }

                var estadoDePagoItem = new EstadoDePagoItem
                {
                    EstadoDePago = CurrentEP,
                    ItemPresupuestoId = epItemViewModel.ItemPresupuesto.ItemPresupuestoId,
                    Descripcion = epItemViewModel.ItemPresupuesto.Descripcion,
                    Unidad = epItemViewModel.ItemPresupuesto.Unidad,
                    CantidadContrato = epItemViewModel.ItemPresupuesto.Cantidad,
                    PrecioUnitario = epItemViewModel.ItemPresupuesto.PrecioUnitario,
                    ImporteContrato = epItemViewModel.ItemPresupuesto.ImporteTotal,
                    CantidadAvancePeriodo = epItemViewModel.CantidadAvancePeriodo,
                    ImporteAvancePeriodo = epItemViewModel.ImporteAvancePeriodo,
                    CantidadAvanceAcumulado = epItemViewModel.CantidadAvanceAcumulado,
                    ImporteAvanceAcumulado = epItemViewModel.ImporteAvanceAcumulado
                };
                context.EstadosDePagoItem.Add(estadoDePagoItem);
            }

            await context.SaveChangesAsync();

            if (estado == "Enviado")
            {
                var notification = new Notificacion
                {
                    Mensaje = $"Nuevo Estado de Pago {CurrentEP.EstadoDePagoId} para el proyecto {Proyecto!.NombreObra} ha sido enviado.",
                    Fecha = DateTime.Now,
                    Leida = false,
                    ProyectoId = Proyecto.ProyectoID
                };
                context.Notificaciones.Add(notification);
                await context.SaveChangesAsync();
            }

            await JSRuntime.InvokeVoidAsync("Swal.fire", "Éxito", $"Estado de Pago guardado como {estado}.", "success");
            NavigationManager.NavigateTo($"/estados-de-pago/detalle/{CurrentEP.EstadoDePagoId}");
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("Swal.fire", "Error", $"Error al guardar el Estado de Pago: {ex.Message}", "error");
        }
    }

    public class EstadoDePagoItemViewModel
    {
        public ItemPresupuesto ItemPresupuesto { get; set; }
        public decimal CantidadAvancePeriodo { get; set; }
        public decimal ImporteAvancePeriodo { get; private set; }
        public decimal CantidadAvanceAcumulado { get; set; }
        public decimal ImporteAvanceAcumulado { get; set; }

        // Gemini: Modified to use FormatUtils
        private static readonly CultureInfo parsingCulture = new CultureInfo("es-CL") { 
            NumberFormat = { 
                CurrencySymbol = "$", CurrencyGroupSeparator = ".", CurrencyDecimalSeparator = ",",
                NumberGroupSeparator = ".", NumberDecimalSeparator = "," 
            }
        };

        public string CantidadAvancePeriodoText
        {
            get => FormatUtils.FormatNumber(CantidadAvancePeriodo, 2);
            set
            {
                if (decimal.TryParse(value, NumberStyles.Any, parsingCulture, out decimal parsedValue))
                {
                    if (parsedValue < 0) parsedValue = 0;
                    if (parsedValue > ItemPresupuesto.Cantidad) parsedValue = ItemPresupuesto.Cantidad;
                    CantidadAvancePeriodo = parsedValue;
                }
            }
        }

        public EstadoDePagoItemViewModel(ItemPresupuesto itemPresupuesto)
        {
            ItemPresupuesto = itemPresupuesto;
            CantidadAvancePeriodo = 0;
            ImporteAvancePeriodo = 0;
            CantidadAvanceAcumulado = 0;
            ImporteAvanceAcumulado = 0;
        }

        public void Recalculate()
        {
            ImporteAvancePeriodo = CantidadAvancePeriodo * ItemPresupuesto.PrecioUnitario;
            CantidadAvanceAcumulado = CantidadAvancePeriodo;
            ImporteAvanceAcumulado = ImporteAvancePeriodo;
        }
    }
}